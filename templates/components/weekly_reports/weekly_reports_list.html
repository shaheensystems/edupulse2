{% comment %} {{course_offering}}
{{weekly_reports}}
{{week_number}}
{{student}} {% endcomment %}




        {% comment %} Week NUmber :{{week_number}} {% endcomment %}

{% if weekly_reports.exists %}
    {% regroup course_offering.weekly_reports.all by week_number as weekly_reports_by_week %}

    {% for week in weekly_reports_by_week %}
            
        {% if week.grouper|stringformat:"s" == week_number|stringformat:"s" %}
       


        <form id="week-form" class="my-4">

            {% csrf_token %}
            

            <table class="min-w-full bg-white border border-gray-300 border-1 rounded-lg overflow-hidden">
                <thead class="bg-[#F4F2FF] text-sm">
                    <tr>
                        <th class="border px-4 py-2">Student</th>
                        <th class="border px-4 py-2">Status</th>
                        
                    
                        {% for session_date in week.list.0.sessions.all|dictsort:"attendance_date" %}
                        <th class="border px-4 py-2">
                            
                            <p class='truncate'>
                                Session {{ forloop.counter }} <br>{{ session_date.attendance_date }}
                            </p>
                        </th>
                        {% endfor %}
                        <th class="border px-4 py-2">Engagement</th>
                        <th class="border px-4 py-2">Action</th>
                        <th class="border px-4 py-2">Follow Up</th>
                        <th class="border px-4 py-2">Last Login Status</th>
                        <th class="border px-4 py-2">No of Page View in canvas</th>
                        <th class="border px-4 py-2">Assessment Status</th> 
                    </tr>
                </thead>
                <tbody>
                    {% for weekly_report in week.list %}
                        <tr class='border-b-2 border-gray-300'>
                            <td class="border px-4 py-2">
                                <span class='text-sm text-gray-800'>{{ weekly_report.student.student.first_name }} {{ weekly_report.student.student.last_name }}</span>
                                <span class='text-xs text-gray-300 mt-2'>  {{ weekly_report.student.email_id }} </span>
                            </td>
                            <td class="border px-4 py-2">
                                <span class="text-sm rounded-lg px-4 py-1 {% if weekly_report.at_risk %} bg-red-300 text-red-500 {% else %} bg-blue-200 text-blue-500 {% endif %} max-w-xs truncate">
                                    {% if weekly_report.at_risk == True %}
                                        <span class='truncate text-xs'> At Risk</span>
                                    {% else %}
                                        <span class="truncate text-xs inline-flex items-center">
                                            <span class="h-2 w-2 bg-blue-800 rounded-full mr-2"></span>
                                            <span>On Track</span>
                                        </span>
                                    {% endif %}
                                </span>    
                            </td>
                        
                            {% for session in weekly_report.sessions.all %}
                                <td class="border px-4 py-2">
                                    <select name="is_present_{{ weekly_report.id }}" class="edited-field border border-gray-300 px-2 py-1 rounded-md text-xs
                                    {% if session.is_present == 'present' %}
                                        bg-[#CDFFCD] text-[#000000]
                                    {% elif session.is_present == 'absent' %}
                                        bg-[#FFE0E0] text-[#D30000]
                                    {% elif session.is_present == 'informed absent' %}
                                        bg-[#FFECCC] text-[#CE8500]
                                    {% endif %}
                                    
                                    "> 
                                        <option value="present" {% if session.is_present == 'present' %}selected{% endif %} >Present</option>
                                        <option value="absent" {% if session.is_present == 'absent' %}selected{% endif %}>Absent</option>
                                        <option value="informed absent" {% if session.is_present == 'informed absent' %}selected{% endif %}>Informed Absent</option>
                                        <option value="tardy" {% if session.is_present == 'tardy' %}selected{% endif %}>Tardy</option>
                                </select>
                                </td>
                            {% endfor %}
                            <td class="border px-4 py-2">
                                <select name="engagement_{{ weekly_report.id }}" class="edited-field border border-gray-300 px-2 py-1 rounded-md text-xs">
                                    <option value="na" {% if weekly_report.engagement == 'na' %}selected{% endif %}>N/A</option>
                                    <option value="on track canvas" {% if weekly_report.engagement == 'on track canvas' %}selected{% endif %}>On Track - CANVAS</option>
                                    <option value="on track assessment" {% if weekly_report.engagement == 'on track assessment' %}selected{% endif %}>On Track - Assessment</option>
                                    <option value="on track learning activity" {% if weekly_report.engagement == 'on track learning activity' %}selected{% endif %}>On Track - Learning Activity'</option>
                                    <option value="on track blended" {% if weekly_report.engagement == 'on track blended' %}selected{% endif %}>On Track - Blended</option>
                                    <option value="not engaged" {% if weekly_report.engagement == 'not engaged' %}selected{% endif %}>Not Engaged</option>

                                </select> 
                            </td>
                            <td class="border px-4 py-2">
                                <select name="action_{{ weekly_report.id }}" class=" border border-gray-300 px-2 py-1 rounded-md text-xs">
                                    <option value="na" {% if weekly_report.action == 'na' %}selected{% endif %}>N/A</option>
                                    <option value="follow up email and call" {% if weekly_report.action == 'follow up email and call' %}selected{% endif %}>Follow Up Email and Call</option>
                                    <option value="pastoral care" {% if weekly_report.action == 'pastoral care' %}selected{% endif %}>Pastoral Care</option>
                                    <option value="personalised study plan/Extra session" {% if weekly_report.action == 'personalised study plan/Extra session' %}selected{% endif %}>Personlaised Study Plan /Extra Session</option>
                                    <option value="emergency contact" {% if weekly_report.action == 'emergency contact' %}selected{% endif %}>Emergency Contact'</option>
                                    <option value="other" {% if weekly_report.action == 'other' %}selected{% endif %}>Other</option>
                                </select> 
                            </td>
                            <td class="border px-4 py-2">
                                <select name="follow_up_{{ weekly_report.id }}" class="edited-field border border-gray-300 px-2 py-1 rounded-md text-xs">
                                    <option value="na" {% if weekly_report.follow_up == 'na' %}selected{% endif %} >N/A</option>
                                    <option value="warning letter 1" {% if weekly_report.follow_up == 'warning letter 1' %}selected{% endif %}>Warning Letter 1</option>
                                    <option value="warning letter 2" {% if weekly_report.follow_up == 'warning letter 2' %}selected{% endif %}>Warning Letter 2</option>
                                </select> 
                            </td>
                        <td class="border px-4 py-2 text-xs">{{ weekly_report.login_in_on_canvas }}</td>
                            <td class="border px-4 py-2 text-xs">{{ weekly_report.no_of_pages_viewed_on_canvas }}</td>
                            <td class="border px-4 py-2">
                                <select name="assessment_status_{{ weekly_report.id }}" class="edited-field border border-gray-300 px-2 py-1 rounded-md text-xs">
                                    <option value="na" {% if weekly_report.assessment_status == 'na' %}selected{% endif %} >N/A</option>
                                    <option value="making progress" {% if weekly_report.assessment_status == 'making progress' %}selected{% endif %} >MAKING PROGRESS</option>
                                    <option value="no progress" {% if weekly_report.assessment_status == 'no progress' %}selected{% endif %}>NO PROGRESS</option>
                                    <option value="request extension" {% if weekly_report.assessment_status == 'request extension' %}selected{% endif %}>REQUEST EXTENSION</option>
                                    <option value="submitted" {% if weekly_report.assessment_status == 'submitted' %}selected{% endif %}>SUBMITTED</option>
                                    <option value="not submitted" {% if weekly_report.assessment_status == 'not submitted' %}selected{% endif %}>NOT SUBMITTED</option>
                                    <option value="failed" {% if weekly_report.assessment_status == 'failed' %}selected{% endif %}>FAILED</option>
                                    <option value="re-sit" {% if weekly_report.assessment_status == 're-sit' %}selected{% endif %}>RE-SIT</option>
                                
                                </select> 
                            </td> 
                            
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        <!-- Add save button to save all data -->
        <div class='bg-blue-500 inline-block items-center mt-4 rounded-md'>
            <button type="button" id="saveButton" class=" text-white px-2 py-2 flex items-center justify-center hidden">Save</button>
        </div>
        <div class='bg-blue-500 inline-block items-center mt-4 rounded-md'>
            <a href="{% url 'edit_weekly_report' course_offering.pk week_number %} " class='bg-sky-300 px-4 py-2  rounded-lg'>Edit report</a>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                
        
                // Add event listener for click event on the save button
                document.getElementById('saveButton').addEventListener('click', function () {
                    // Collect form data
                    var formData = new FormData(document.getElementById('week-form'));
                    console.log("saving Weekly report data ")
            
                    
                    // Send an AJAX request to save the data
                    fetch('/save-weekly-reports', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => {
                        if (response.ok) {
                            // Data saved successfully
                            console.log('Data saved successfully');
                            // Optionally, you can perform additional actions here
                        } else {
                            // Failed to save data
                            console.error('Failed to save data');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        </script>

        
        </form>
       
        {% endif %}
    {% endfor %}
      

{% else %}
        <div class='flex flex-col gap-4 m-2'>
            <span>
                No Weekly Reports !!!

            </span>
            <span>
                <a href="{% url 'create-attendance' course_offering.pk %}" class="bg-blue-300  px-4 py-2 rounded-lg">Take Attendance</a>
            </span>

            
        
        </div>
            


{% endif %}





